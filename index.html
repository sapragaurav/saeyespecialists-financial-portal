<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SA Eye Specialists Portal - V3.8</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; display: flex; justify-content: center; }
        .card { background: white; padding: 0; border-radius: 15px; box-shadow: 0 8px 24px rgba(0,0,0,0.1); width: 100%; max-width: 1250px; position: relative; overflow: hidden; min-height: 85vh; display: flex; flex-direction: column; }
        
        /* LOGIN */
        #loginSection { padding: 60px 30px; text-align: center; max-width: 400px; margin: auto; }
        .login-logo { max-width: 200px; margin-bottom: 20px; }
        .login-input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }

        /* HEADER */
        .app-header { background: #fff; border-bottom: 1px solid #dee2e6; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; height: 70px; }
        .header-logo { height: 45px; margin-right: 20px; }
        
        /* TABS */
        .tabs-area { display: flex; height: 100%; }
        .tab-btn { padding: 0 25px; border: none; background: none; cursor: pointer; font-size: 15px; font-weight: 600; color: #6c757d; border-bottom: 3px solid transparent; transition: 0.2s; height: 100%; }
        .tab-btn:hover { background: #f8f9fa; color: #0056b3; }
        .tab-btn.active { color: #0056b3; border-bottom: 3px solid #0056b3; background: #fff; }
        
        .user-area { display: flex; align-items: center; gap: 15px; border-left: 1px solid #eee; height: 100%; padding-left: 20px; }
        .logout-btn { color: #dc3545; background: #fff0f0; border: 1px solid #ffc9c9; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 13px; }

        /* CONTENT */
        .tab-content { display: none; padding: 30px; flex: 1; overflow-y: auto; }
        .tab-content.active { display: block; }
        
        /* DASHBOARD */
        .fy-selector { background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; border: 1px solid #bbdefb; }
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .stat-card { background: #fff; border: 1px solid #eee; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); transition: transform 0.2s; }
        .stat-card h3 { margin-top: 0; color: #555; font-size: 14px; text-transform: uppercase; }
        .big-num { font-size: 28px; font-weight: bold; color: #0056b3; margin: 10px 0; }
        .clickable-card { cursor: pointer; border: 1px solid #b3d7ff; }
        .clickable-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,86,179,0.15); }

        /* DATA TABLE */
        .filter-bar { background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 20px; display: flex; gap: 12px; align-items: center; border: 1px solid #eee; flex-wrap: wrap; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 10px; }
        th { background: #f1f3f5; padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6; }
        td { padding: 12px; border-bottom: 1px solid #eee; }
        .money-col { text-align: right; font-family: 'Courier New', monospace; font-weight: 600; }
        .total-row { font-weight: bold; background: #e7f3ff; font-size: 14px; }

        /* SETTINGS */
        .settings-container { display: flex; gap: 30px; height: 100%; min-height: 500px; border-top: 1px solid #f0f0f0; padding-top: 20px; }
        .doctor-list { width: 280px; border-right: 1px solid #eee; padding-right: 20px; overflow-y: auto; }
        .doctor-item { padding: 12px; border-radius: 8px; cursor: pointer; margin-bottom: 8px; border: 1px solid transparent; background: #fcfcfc; transition: 0.2s; }
        .doctor-item.selected { background: #e7f1ff; color: #0056b3; font-weight: bold; border-color: #0056b3; }
        .input-group { display: flex; gap: 10px; margin-bottom: 12px; align-items: center; background: #f8f9fa; padding: 10px; border-radius: 6px; }

        /* GLOBAL UTILS */
        .btn { padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: bold; }
        .btn-primary { background-color: #0056b3; color: white; }
        .btn-green { background-color: #28a745; color: white; }
        .btn-danger { background-color: #dc3545; color: white; padding: 5px 10px; }
        .btn-purple { background-color: #6f42c1; color: white; }
        .hidden { display: none; }
        .version-display { padding: 10px 20px; font-size: 11px; color: #999; border-top: 1px solid #eee; background: #fdfdfd; display: flex; justify-content: space-between; }
    </style>
</head>
<body>

<img id="pdfLogoSource" src="logo.png" style="display:none;" alt="Logo Source">

<div class="card">
    <div id="loginSection">
        <img src="logo.png" alt="SA Eye Specialists" class="login-logo" onerror="this.style.display='none'; document.getElementById('backupTitle').style.display='block';">
        <h2 id="backupTitle" style="color:#0056b3; display:none;">SA Eye Specialists</h2>
        <p style="color:#666; margin-bottom:25px;">Financial Portal Login</p>
        <input type="email" id="email" class="login-input" placeholder="Email">
        <input type="password" id="password" class="login-input" placeholder="Password">
        <button class="btn btn-primary" style="width:100%; margin-top:15px; padding:15px;" id="loginBtn">Sign In</button>
        <p style="font-size: 10px; color: #ccc; margin-top: 20px;">Build V3.8</p>
    </div>

    <div id="appSection" class="hidden">
        <div class="app-header">
            <div style="display:flex; align-items:center;">
                <img src="logo.png" class="header-logo" alt="Logo">
                <div class="tabs-area">
                    <button class="tab-btn active" id="tabBtnVisuals" onclick="switchTab('visuals')">Financial Dashboard</button>
                    <button class="tab-btn" id="tabBtnData" onclick="switchTab('data')">Financial Data</button>
                    <button class="tab-btn" id="tabBtnSet" onclick="switchTab('settings')">Doctor Settings (Fees)</button>
                </div>
            </div>
            <div class="user-area">
                <span id="userNameDisplay" style="font-size:13px; color:#555; font-weight:600;">Admin</span>
                <button class="logout-btn" onclick="logout()">Sign Out</button>
            </div>
        </div>

        <div id="tab-visuals" class="tab-content active">
            <div class="fy-selector">
                <strong>üìÖ Select Financial Year:</strong>
                <select id="fyDropdown" style="padding:8px; border-radius:4px; font-weight:bold; min-width:150px;">
                    <option>Loading...</option>
                </select>
                <span style="font-size:12px; color:#666; margin-left:10px;">(Jul 1 - Jun 30)</span>
            </div>

            <div style="display:flex; gap:20px; margin-bottom:20px;">
                <div class="stat-card clickable-card" style="flex:1;" onclick="goToDataTabWithFY()">
                    <h3>Total Billings (Click for Data)</h3>
                    <div class="big-num" id="dashTotalRev">$0.00</div>
                    <span style="font-size:11px; color:#0056b3;">View Details &rarr;</span>
                </div>
        
                <div class="stat-card" style="flex:1;">
                    <h3>Total Practice Revenue</h3>
                    <div class="big-num" id="dashPracRev" style="color:#28a745;">$0.00</div>
                    <span style="font-size:11px; color:#666;">Calculated from Commission</span>
                </div>
            </div>

            <div class="dashboard-grid">
                <div class="stat-card">
                    <h3>Billings by Doctor</h3>
                    <canvas id="chartBillBar" style="max-height: 300px;"></canvas>
                </div>
                <div class="stat-card">
                    <h3>Practice Revenue by Doctor</h3>
                    <canvas id="chartPracBar" style="max-height: 300px;"></canvas>
                </div>
            </div>

            <div class="dashboard-grid" style="margin-top: 20px;">
                <div class="stat-card">
                    <h3>Monthly Billing Trend</h3>
                    <canvas id="chartBillLine" style="max-height: 300px;"></canvas>
                </div>
                <div class="stat-card">
                    <h3>Monthly Practice Revenue Trend</h3>
                    <canvas id="chartPracLine" style="max-height: 300px;"></canvas>
                </div>
            </div>
        </div>

        <div id="tab-data" class="tab-content">
            <div class="filter-bar">
                <select id="dataFyFilter" style="padding:8px; border-radius:4px; border:1px solid #ccc; font-weight:bold; background:#e3f2fd;">
                    <option value="">-- All FYs --</option>
                </select>
                <select id="monthFilter" style="padding:8px; border-radius:4px;"><option value="">-- All Months --</option></select>
                <input type="text" id="doctorFilter" placeholder="Search Doctor..." style="padding:8px; border:1px solid #ccc; border-radius:4px;">
                
                <button class="btn btn-primary" id="applyFilters">Apply Filters</button>
                <button class="btn" id="clearFilters" style="background:#6c757d; color:white;">Clear</button>
                
                <div style="flex:1; text-align:right; display:flex; justify-content:flex-end; gap:10px;">
                    <button class="btn btn-purple" onclick="generatePDF()">üìÑ Download PDF Report</button>
                    <input type="file" id="excelFile" class="hidden" accept=".xlsx, .xls">
                    <button class="btn btn-green" onclick="document.getElementById('excelFile').click()">+ Upload Excel</button>
                </div>
            </div>
            
            <p id="uploadStatus" style="text-align:center; font-size:13px; font-weight:bold; height:20px;"></p>

            <div style="overflow-x:auto;">
                <table id="dataTableElement">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Doctor</th>
                            <th>Location</th>
                            <th class="money-col">Billings</th> <th style="text-align:center;">Commission Rate</th> <th class="money-col">Practice Revenue</th> <th class="money-col">GST</th>
                            <th class="money-col">Remittance</th>
                            <th style="text-align:center;">Action</th>
                        </tr>
                    </thead>
                    <tbody id="recordsTableBody"></tbody>
                    <tfoot>
                        <tr class="total-row">
                            <td colspan="3" style="text-align:right;">TOTALS:</td>
                            <td class="money-col" id="totalReceived">$0.00</td><td></td>
                            <td class="money-col" id="totalFee">$0.00</td><td class="money-col" id="totalGST">$0.00</td>
                            <td class="money-col" id="totalRemit">$0.00</td><td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <div id="tab-settings" class="tab-content">
            <div class="settings-container">
                <div class="doctor-list">
                    <h3 style="margin-top:0; font-size:14px; text-transform:uppercase; color:#888;">Doctor List</h3>
                    <div id="doctorListPanel"></div>
                </div>
                <div class="config-panel" id="configPanel" style="display:none;">
                    
                    <h2 id="configTitle" style="margin-top:0; color:#0056b3; border-bottom:2px solid #eee; padding-bottom:15px;"></h2>
                    
                    <div style="background:#f1f3f5; padding:15px; border-radius:8px; margin-bottom:15px;">
                        <strong>üè¶ Bank Details</strong>
                        <div style="display:flex; gap:10px; margin-top:10px;">
                            <input type="text" id="docBSB" placeholder="BSB (e.g. 123-456)" class="login-input" style="margin:0;">
                            <input type="text" id="docAcc" placeholder="Account Number" class="login-input" style="margin:0;">
                        </div>
                    </div>

                    <div class="rule-card">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                            <strong>üìÖ Fee Timeline</strong>
                            <button class="btn btn-primary" style="padding:5px 12px;" onclick="addTimelineRow()">+ Add Period</button>
                        </div>
                        <div id="timelineContainer"></div>
                    </div>
                    <div class="rule-card" style="border-left: 5px solid #ffc107;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                            <strong>‚ö†Ô∏è Monthly Exceptions</strong>
                            <button class="btn btn-primary" style="padding:5px 12px;" onclick="addExceptionRow()">+ Add Exception</button>
                        </div>
                        <div id="exceptionsContainer"></div>
                    </div>
                    <button class="btn btn-green" style="width:100%; padding:15px; font-size:16px;" onclick="saveDoctorSettings()">SAVE SETTINGS</button>
                    <p id="saveStatus" style="text-align:center; font-weight:bold; margin-top:15px; color:green;"></p>
                </div>
                <div id="noDocSelected" style="flex:1; display:flex; align-items:center; justify-content:center; color:#999; font-style:italic;">Select a doctor.</div>
            </div>
        </div>
        
        <div class="version-display">
            <span>Build Version: 3.8</span>
            <span id="dbStatus">System Status: Ready</span>
        </div>
    </div>
</div>

<script>
    // --- SETUP ---
    const firebaseConfig = {
        apiKey: "AIzaSyAsCKNyHipM5kUKKqJ_klJ1J1l20E4iQ-k",
        authDomain: "saeyespecialists-portal.firebaseapp.com",
        projectId: "saeyespecialists-portal",
        storageBucket: "saeyespecialists-portal.firebasestorage.app",
        messagingSenderId: "584706843504",
        appId: "1:584706843504:web:9b7e3e5307f162de55e5b5"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    
    let allRecords = [];
    let doctorSettingsMap = {};
    let charts = {};
    let currentEditingDoc = ""; // Added Global Variable for Safety
    const DOCTOR_COLORS = ['#0056b3', '#28a745', '#dc3545', '#ffc107', '#17a2b8', '#6610f2', '#fd7e14', '#20c997', '#e83e8c', '#6f42c1'];

    const formatCurr = (n) => new Intl.NumberFormat('en-AU', { style: 'currency', currency: 'AUD' }).format(n);
    const parseDate = (str) => { if(!str) return new Date(0); const [d,m,y] = str.split('/'); return new Date(`${y}-${m}-${d}`); };
    const getFinancialYear = (d) => {
        const y = d.getFullYear(); const m = d.getMonth();
        const startY = m >= 6 ? y : y - 1;
        const endY = startY + 1;
        return `FY${startY.toString().substr(2)}/${endY.toString().substr(2)}`;
    };

    // --- AUTH ---
    const loginFunc = () => auth.signInWithEmailAndPassword(document.getElementById('email').value, document.getElementById('password').value).catch(e => alert(e.message));
    document.getElementById('loginBtn').onclick = loginFunc;
    document.getElementById('password').addEventListener("keypress", (e) => { if(e.key === "Enter") loginFunc(); });
    window.logout = () => auth.signOut().then(() => location.reload());

    auth.onAuthStateChanged(user => {
        if (user) {
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('appSection').classList.remove('hidden');
            loadAllData();
        }
    });

    // --- MAIN DATA LOADER ---
    async function loadAllData() {
        document.getElementById('dbStatus').innerText = "Status: Loading...";
        try {
            const sSnap = await db.collection("doctor_settings").get();
            doctorSettingsMap = {}; sSnap.forEach(d => doctorSettingsMap[d.id] = d.data());

            const rSnap = await db.collection("daily_reports").get();
            allRecords = []; rSnap.forEach(d => { let r=d.data(); r.id=d.id; r.jsDate=parseDate(r.reportDate); allRecords.push(r); });

            document.getElementById('dbStatus').innerText = `Status: Online | ${allRecords.length} Records`;
            
            initFYDropdowns();
            populateMonthDropdown();
            renderVisuals();
            renderDoctorList();
        } catch (e) { document.getElementById('dbStatus').innerText = "Error: " + e.message; }
    }

// --- FINAL PDF GENERATION (V3.7 - Merged) ---
    window.generatePDF = function() {
        const docName = document.getElementById('doctorFilter').value;
        const monthFilter = document.getElementById('monthFilter').value;
        const fyFilter = document.getElementById('dataFyFilter').value;
        
        if(!docName) { alert("Please filter by a specific Doctor first."); return; }
        
        // 1. GET FILTERED DATA
        const pdfData = allRecords.filter(r => {
            const matchFY = !fyFilter || getFinancialYear(r.jsDate) === fyFilter;
            const matchM = !monthFilter || r.jsDate.toLocaleString('default', { month: 'short', year: 'numeric' }) === monthFilter;
            const matchDoc = r.doctorName === docName;
            return matchFY && matchM && matchDoc;
        });

        // 2. DATA PREPARATION
        const cashKey = "CashReceived";
        const tyroKeys = [
            "EFTPOSReceived", "CreditCardReceived", "ExtrasCoverReceived", 
            "BankTransferReceived", "ChequeReceived", "DepositApplied", 
            "BulkBillReceived", "DVAReceived", "ECLIPSEReceived", "90DayGapReceived"
        ];
        
        // Buckets for totals
        let totalTyro = 0;
        let totalCash = 0;
        let totalCommission = 0; 
        let totalGST = 0;
        let breakdown = {};
        [cashKey, ...tyroKeys].forEach(k => breakdown[k] = 0);

        // Loop through data
        pdfData.forEach(r => {
            // Cash
            const cVal = r[cashKey] || 0;
            totalCash += cVal;
            breakdown[cashKey] += cVal;

            // Tyro
            let rTyro = 0;
            tyroKeys.forEach(k => {
                const val = r[k] || 0;
                rTyro += val;
                breakdown[k] += val;
            });
            totalTyro += rTyro;

            // Commission (Record by Record)
            const totalBillingsForRecord = cVal + rTyro;
            const {rate} = getRate(r.doctorName, r.jsDate);
            const fee = totalBillingsForRecord * (rate / 100);
            totalCommission += fee;
        });

        // Final Calculations
        totalGST = totalCommission * 0.10;
        const totalPayableToSAES = totalCommission + totalGST;
        const finalBalance = totalPayableToSAES - totalCash;
        const totalBillings = totalTyro + totalCash;

        // --- START PDF DRAWING ---
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        const logoImg = document.getElementById('pdfLogoSource');
        if (logoImg.complete) doc.addImage(logoImg, 'PNG', 15, 10, 40, 15);
        
        // HEADER
        doc.setFontSize(16); doc.text("TAX INVOICE", 195, 20, { align: "right" });
        doc.setFontSize(10); doc.setTextColor(100);
        const reportPeriod = monthFilter ? monthFilter : (fyFilter || "All Time");
        doc.text(`Period: ${reportPeriod}`, 195, 27, { align: "right" });
        doc.text(`Date: ${new Date().toLocaleDateString()}`, 195, 32, { align: "right" });

        // BANK DETAILS
        doc.setTextColor(0); doc.setFont(undefined, 'bold');
        doc.text("Pay to: SA Eye Specialists", 195, 42, { align: "right" });
        doc.setFont(undefined, 'normal');
        doc.text("BSB: 065 137", 195, 47, { align: "right" });
        doc.text("Account: 1105 9977", 195, 52, { align: "right" });

        doc.setFontSize(12); doc.setTextColor(0); doc.text(`To: ${docName}`, 15, 40);
        
        // --- TOP SUMMARY BOX (Restored & Fixed Overlap) ---
        // I increased the box height slightly and adjusted X positions for clarity
        doc.setFillColor(245, 245, 245); doc.rect(15, 60, 180, 30, 'F');
        doc.setFontSize(10);
        
        // Left Column (Billings)
        doc.text("Total Billings:", 20, 70);       
        doc.text(formatCurr(totalBillings), 65, 70, { align: "right" });
        
        doc.text("Practice Revenue:", 20, 78);    
        doc.text(formatCurr(totalCommission), 65, 78, { align: "right" });

        // Right Column (Cash & Balance)
        doc.text("Cash at SAES:", 100, 70);          
        doc.text(formatCurr(totalCash), 160, 70, { align: "right" });

        doc.setFont(undefined, 'bold');
        doc.text("Balance Payable:", 100, 78);   
        doc.text(formatCurr(finalBalance), 160, 78, { align: "right" });
        doc.setFont(undefined, 'normal');

        // --- MAIN TRANSACTION TABLE (Restored) ---
        doc.autoTable({
            html: '#dataTableElement', 
            startY: 95, 
            theme: 'striped', 
            headStyles: { fillColor: [0, 86, 179] },
            columns: [ 
                { header: 'Date', dataKey: 0 }, 
                { header: 'Location', dataKey: 2 }, 
                { header: 'Billings', dataKey: 3 }, 
                { header: 'Prac Rev', dataKey: 5 }, 
                { header: 'GST', dataKey: 6 }, 
                { header: 'Remit', dataKey: 7 } 
            ],
            didParseCell: function(data) { 
                // Hide columns 1 (Doctor - redundant), 4 (Rate), 8 (Action)
                if (data.column.index === 1 || data.column.index === 4 || data.column.index === 8) data.cell.styles.display = 'none'; 
            }
        });

        // --- BOTTOM TAX INVOICE TABLE (The New Calculation) ---
        let finalY = doc.lastAutoTable.finalY + 15;
        
        // Check if we need a new page
        if (finalY > 200) { doc.addPage(); finalY = 20; }

        doc.setFontSize(11); doc.setTextColor(0); doc.setFont(undefined, 'bold');
        doc.text("Payment Breakdown & Tax Invoice Calculation", 15, finalY);
        doc.setLineWidth(0.5); doc.line(15, finalY + 2, 95, finalY + 2);

        // Build the Rows
        let tableBody = [];
        
        // 1. Tyro Items
        tyroKeys.forEach(key => {
            if(breakdown[key] > 0) {
                const label = key.replace(/([A-Z])/g, ' $1').replace('Received','').trim(); 
                tableBody.push([label, formatCurr(breakdown[key]), "-"]);
            }
        });

        // 2. Cash Item
        tableBody.push(["Cash", "-", formatCurr(totalCash)]);

        // 3. Receipts Total
        tableBody.push([
            { content: "Total Receipts", styles: { fontStyle: 'bold', fillColor: [240, 240, 240] } },
            { content: formatCurr(totalTyro), styles: { fontStyle: 'bold', fillColor: [240, 240, 240] } },
            { content: formatCurr(totalCash), styles: { fontStyle: 'bold', fillColor: [240, 240, 240] } }
        ]);

        // Helper for summary rows
        const addSummaryRow = (label, value, isBold = false) => {
            tableBody.push([
                { content: label, colSpan: 2, styles: { halign: 'right', fontStyle: isBold ? 'bold' : 'normal' } },
                { content: formatCurr(value), styles: { fontStyle: isBold ? 'bold' : 'normal' } }
            ]);
        };

        // 4. Commission & GST
        tableBody.push([{ content: "", colSpan: 3, styles: { cellPadding: 1, fillColor: [255, 255, 255] } }]); // Spacer
        addSummaryRow(`Practice Commission`, totalCommission);
        addSummaryRow("GST (10%)", totalGST);
        
        // 5. Total Payable
        tableBody.push([
            { content: "Total Payable to SAES", colSpan: 2, styles: { halign: 'right', fontStyle: 'bold', fillColor: [231, 241, 255] } },
            { content: formatCurr(totalPayableToSAES), styles: { fontStyle: 'bold', fillColor: [231, 241, 255], textColor: [0, 86, 179] } }
        ]);

        // 6. Less Cash
        addSummaryRow("Less: Cash already received at SAES", -totalCash);

        // 7. Final Balance
        tableBody.push([
            { content: `Balance Payable to SAES (${reportPeriod})`, colSpan: 2, styles: { halign: 'right', fontStyle: 'bold', fontSize: 11, fillColor: [0, 86, 179], textColor: [255, 255, 255] } },
            { content: formatCurr(finalBalance), styles: { fontStyle: 'bold', fontSize: 11, fillColor: [0, 86, 179], textColor: [255, 255, 255] } }
        ]);

        doc.autoTable({
            startY: finalY + 5,
            head: [['Description', 'Received in Tyro', 'Cash at SAES']],
            body: tableBody,
            theme: 'grid',
            headStyles: { fillColor: [0, 86, 179] }, // Blue Header
            columnStyles: { 
                0: { cellWidth: 80 },
                1: { halign: 'right', font: 'courier' },
                2: { halign: 'right', font: 'courier' }
            }
        });

        // Footer
        const pageHeight = doc.internal.pageSize.height;
        doc.setFontSize(8); doc.setTextColor(150);
        doc.text("SA Eye Specialists - Financial Portal", 105, pageHeight - 10, { align: "center" });
        
        const fileName = `Invoice_${docName}_${reportPeriod}.pdf`.replace(/[^a-z0-9]/gi, '_');
        doc.save(fileName);
    };    
    // --- DROPDOWNS ---
    function initFYDropdowns() {
        const fySet = new Set(); allRecords.forEach(r => fySet.add(getFinancialYear(r.jsDate)));
        const sortedFY = Array.from(fySet).sort().reverse();
        const selDash = document.getElementById('fyDropdown'); selDash.innerHTML = "";
        if (sortedFY.length === 0) selDash.innerHTML = "<option>No Data</option>";
        sortedFY.forEach(fy => selDash.innerHTML += `<option value="${fy}">${fy}</option>`);
        const selData = document.getElementById('dataFyFilter'); selData.innerHTML = '<option value="">-- All FYs --</option>';
        sortedFY.forEach(fy => selData.innerHTML += `<option value="${fy}">${fy}</option>`);
        selDash.onchange = renderVisuals; selData.onchange = populateMonthDropdown;
    }
    
    function populateMonthDropdown() {
        const selectedFY = document.getElementById('dataFyFilter').value;
        const sel = document.getElementById('monthFilter');
        let relevantRecords = allRecords;
        if (selectedFY) relevantRecords = allRecords.filter(r => getFinancialYear(r.jsDate) === selectedFY);
        const months = [...new Set(relevantRecords.map(r => r.jsDate.toLocaleString('default', { month: 'short', year: 'numeric' })))];
        months.sort((a,b) => new Date(b) - new Date(a));
        sel.innerHTML = '<option value="">-- All Months --</option>';
        months.forEach(m => sel.innerHTML += `<option value="${m}">${m}</option>`);
    }

    // --- VISUALS & CHARTS ---
    function renderVisuals() {
        const selectedFY = document.getElementById('fyDropdown').value;
        if(!allRecords.length || selectedFY === "No Data") return;
        
        const fyRecords = allRecords.filter(r => getFinancialYear(r.jsDate) === selectedFY);

        // --- UPDATED VISUALS (4 Charts) ---
    function renderVisuals() {
        const selectedFY = document.getElementById('fyDropdown').value;
        if(!allRecords.length || selectedFY === "No Data") return;
        
        const fyRecords = allRecords.filter(r => getFinancialYear(r.jsDate) === selectedFY);

        // 1. Calculate Totals
        let totalBillings = 0;
        let totalPracticeRev = 0;

        // 2. Prepare Data Buckets (4 Buckets now)
        const billByDoc = {}; 
        const pracByDoc = {};
        const billTrends = {}; 
        const pracTrends = {};

        fyRecords.forEach(r => {
            const valReceived = r.AmountReceived || 0; 
            const {rate} = getRate(r.doctorName, r.jsDate);
            const fee = valReceived * (rate / 100);

            // Grand Totals
            totalBillings += valReceived;
            totalPracticeRev += fee;

            // Populate Bar Charts Data
            billByDoc[r.doctorName] = (billByDoc[r.doctorName] || 0) + valReceived;
            pracByDoc[r.doctorName] = (pracByDoc[r.doctorName] || 0) + fee;

            // Populate Line Charts Data (Trends)
            if(!billTrends[r.doctorName]) billTrends[r.doctorName] = Array(12).fill(0);
            if(!pracTrends[r.doctorName]) pracTrends[r.doctorName] = Array(12).fill(0);
            
            const mIndex = r.jsDate.getMonth(); 
            let fyIndex = (mIndex + 6) % 12; // Shift so July is index 0
            
            billTrends[r.doctorName][fyIndex] += valReceived;
            pracTrends[r.doctorName][fyIndex] += fee;
        });

        // 3. Update Text Cards
        document.getElementById('dashTotalRev').innerText = formatCurr(totalBillings);
        document.getElementById('dashPracRev').innerText = formatCurr(totalPracticeRev);
        
        // 4. Draw Charts
        const docNames = Object.keys(billByDoc);
        const monthKeys = ["Jul", "Aug", "Sep", "Oct", "Nov", "Dec", "Jan", "Feb", "Mar", "Apr", "May", "Jun"];

        // Helper to generate datasets
        const getBarDataset = (dataObj) => docNames.map((name, i) => ({ 
            label: name, 
            data: [dataObj[name]], 
            backgroundColor: DOCTOR_COLORS[i % DOCTOR_COLORS.length] 
        }));

        const getLineDataset = (dataObj) => Object.keys(dataObj).map((docName, i) => {
            const docIndex = docNames.indexOf(docName);
            const color = (docIndex !== -1) ? DOCTOR_COLORS[docIndex % DOCTOR_COLORS.length] : '#000';
            return { 
                label: docName, 
                data: dataObj[docName], 
                borderColor: color, 
                backgroundColor: 'transparent', 
                tension: 0.1 
            };
        });

        // Render Row 1 (Bars)
        createChart('chartBillBar', 'bar', ['Billings'], getBarDataset(billByDoc), 'bar');
        createChart('chartPracBar', 'bar', ['Revenue'], getBarDataset(pracByDoc), 'bar');

        // Render Row 2 (Lines)
        createChart('chartBillLine', 'line', monthKeys, getLineDataset(billTrends), 'line');
        createChart('chartPracLine', 'line', monthKeys, getLineDataset(pracTrends), 'line');
    }

    function createChart(canvasId, type, labels, datasets, mode) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        if(charts[canvasId]) charts[canvasId].destroy();
        charts[canvasId] = new Chart(ctx, {
            type: type, data: { labels, datasets },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: true, position: 'top' } },
                scales: mode === 'bar' ? { x: { ticks: { display: false } } } : {},
                onClick: (e, activeEls) => {
                    if (activeEls.length > 0) {
                        const dsIndex = activeEls[0].datasetIndex;
                        const index = activeEls[0].index;
                        const activeFY = document.getElementById('fyDropdown').value;
                        switchTab('data'); document.getElementById('dataFyFilter').value = activeFY;
                        
                        if (mode === 'bar') { document.getElementById('doctorFilter').value = datasets[dsIndex].label; } 
                        else if (mode === 'line') {
                            const docName = datasets[dsIndex].label; const monthShort = labels[index];
                            const years = activeFY.replace("FY","").split("/");
                            const year = (index <= 5) ? "20"+years[0] : "20"+years[1];
                            document.getElementById('doctorFilter').value = docName;
                            populateMonthDropdown();
                            document.getElementById('monthFilter').value = `${monthShort} ${year}`;
                        }
                        document.getElementById('applyFilters').click();
                    }
                }
            }
        });
    }

    window.goToDataTabWithFY = function() {
        const activeFY = document.getElementById('fyDropdown').value;
        if(activeFY && activeFY !== "No Data") {
            switchTab('data'); document.getElementById('dataFyFilter').value = activeFY;
            populateMonthDropdown(); document.getElementById('applyFilters').click();
        }
    };

    // --- TABLE ---
    document.getElementById('applyFilters').onclick = () => {
        const fy = document.getElementById('dataFyFilter').value;
        const m = document.getElementById('monthFilter').value;
        const doc = document.getElementById('doctorFilter').value.toLowerCase();
        const filtered = allRecords.filter(r => {
            const matchFY = !fy || getFinancialYear(r.jsDate) === fy;
            const matchM = !m || r.jsDate.toLocaleString('default', { month: 'short', year: 'numeric' }) === m;
            const matchDoc = !doc || r.doctorName.toLowerCase().includes(doc);
            return matchFY && matchM && matchDoc;
        });
        renderDashboard(filtered);
    };
    document.getElementById('clearFilters').onclick = () => {
        document.getElementById('dataFyFilter').value = ""; populateMonthDropdown();
        document.getElementById('monthFilter').value = ""; document.getElementById('doctorFilter').value = "";
        renderDashboard(allRecords);
    };
    function renderDashboard(data) {
        const tbody = document.getElementById('recordsTableBody'); tbody.innerHTML = "";
        let tRec=0, tFee=0, tGST=0, tRem=0;
        
        data.sort((a,b) => b.jsDate - a.jsDate).forEach(d => {
            const valReceived = d.AmountReceived || 0; 
            const {rate, isEx} = getRate(d.doctorName, d.jsDate);
            
            const fee = valReceived * (rate / 100); 
            const gst = fee * 0.10; 
            const remit = valReceived - (fee + gst);
            
            tRec += valReceived; tFee += fee; tGST += gst; tRem += remit;
            
            const badge = isEx ? `<span style="background:#fff3cd; color:#856404; padding:2px 6px; border-radius:4px; font-size:11px;">${rate}% (Ex)</span>` : `<span style="background:#e7f1ff; color:#0056b3; padding:2px 6px; border-radius:4px; font-size:11px;">${rate}%</span>`;
            
            tbody.innerHTML += `<tr><td>${d.reportDate}</td><td style="font-weight:600;">${d.doctorName}</td><td>${d.location}</td><td class="money-col">${formatCurr(valReceived)}</td><td style="text-align:center;">${badge}</td><td class="money-col">${formatCurr(fee)}</td><td class="money-col">${formatCurr(gst)}</td><td class="money-col" style="color:#28a745;">${formatCurr(remit)}</td><td style="text-align:center;"><button class="btn btn-danger" style="font-size:10px;" onclick="deleteRecord('${d.id}')">Del</button></td></tr>`;
        });
        
        document.getElementById('totalReceived').innerText = formatCurr(tRec); 
        document.getElementById('totalFee').innerText = formatCurr(tFee);
        document.getElementById('totalGST').innerText = formatCurr(tGST); 
        document.getElementById('totalRemit').innerText = formatCurr(tRem);
    }
    
    // --- SHARED UTILS ---
    function getRate(docName, jsDate) {
        const set = doctorSettingsMap[docName]; if(!set) return { rate: 0, isEx: false };
        const mStr = jsDate.toLocaleString('default', { month: 'short', year: 'numeric' });
        if(set.exceptions && set.exceptions[mStr] !== undefined) return { rate: parseFloat(set.exceptions[mStr]), isEx: true };
        if(set.timeline && set.timeline.length > 0) {
            const sorted = [...set.timeline].sort((a,b) => new Date(b.startDate) - new Date(a.startDate));
            const rule = sorted.find(r => new Date(r.startDate) <= jsDate); if(rule) return { rate: parseFloat(rule.fee), isEx: false };
        }
        return { rate: 0, isEx: false };
    }
    window.switchTab = (tab) => {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active')); document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`tab-${tab}`).classList.add('active');
        let btnId = 'tabBtnVisuals'; if(tab === 'data') btnId = 'tabBtnData'; if(tab === 'settings') btnId = 'tabBtnSet';
        document.getElementById(btnId).classList.add('active');
    };
    function renderDoctorList() {
        const doctors = [...new Set(allRecords.map(r => r.doctorName))].sort();
        const panel = document.getElementById('doctorListPanel'); panel.innerHTML = "";
        doctors.forEach(name => {
            const div = document.createElement('div'); div.className = "doctor-item"; div.innerText = name;
            div.onclick = () => { document.querySelectorAll('.doctor-item').forEach(i => i.classList.remove('selected')); div.classList.add('selected'); openConfig(name); };
            panel.appendChild(div);
        });
    }
    
    // --- DOCTOR SETTINGS ---
    function openConfig(name) {
        currentEditingDoc = name;
        document.getElementById('noDocSelected').style.display = 'none';
        document.getElementById('configPanel').style.display = 'block';
        document.getElementById('configTitle').innerText = name;
        
        const set = doctorSettingsMap[name] || { timeline: [], exceptions: {}, bsb: "", acc: "" };
        
        // 1. LOAD BANK DETAILS
        document.getElementById('docBSB').value = set.bsb || "";
        document.getElementById('docAcc').value = set.acc || "";

        // 2. LOAD TIMELINES
        document.getElementById('timelineContainer').innerHTML = "";
        (set.timeline || []).forEach(r => addTimelineRow(r.startDate, r.fee));

        // 3. LOAD EXCEPTIONS
        document.getElementById('exceptionsContainer').innerHTML = "";
        Object.entries(set.exceptions || {}).forEach(([m, f]) => addExceptionRow(m, f));
    }
    window.addTimelineRow = (d="", f="") => {
        const div = document.createElement('div'); div.className = "input-group";
        div.innerHTML = `<input type="date" class="tl-d" value="${d}"><input type="number" class="tl-f" value="${f}" style="width:60px;"><button class="btn btn-danger" onclick="this.parentElement.remove()">√ó</button>`;
        document.getElementById('timelineContainer').appendChild(div);
    };
    window.addExceptionRow = (m="", f="") => {
        const div = document.createElement('div'); div.className = "input-group";
        div.innerHTML = `<input type="text" class="ex-m" value="${m}" placeholder="Nov 2025"><input type="number" class="ex-f" value="${f}" style="width:60px;"><button class="btn btn-danger" onclick="this.parentElement.remove()">√ó</button>`;
        document.getElementById('exceptionsContainer').appendChild(div);
    };
    window.saveDoctorSettings = async () => {
        const tl = [];
        document.querySelectorAll('.tl-d').forEach((el, i) => {
            const f = document.querySelectorAll('.tl-f')[i].value;
            if(el.value && f) tl.push({ startDate: el.value, fee: f });
        });

        const ex = {};
        document.querySelectorAll('.ex-m').forEach((el, i) => {
            const f = document.querySelectorAll('.ex-f')[i].value;
            if(el.value && f) ex[el.value] = f;
        });

        const bsb = document.getElementById('docBSB').value;
        const acc = document.getElementById('docAcc').value;

        try {
            await db.collection("doctor_settings").doc(currentEditingDoc).set({ 
                timeline: tl, 
                exceptions: ex,
                bsb: bsb,
                acc: acc
            });
            document.getElementById('saveStatus').innerText = "Saved!";
            document.getElementById('saveStatus').style.color = "green";
            
            loadAllData();
        } catch (e) {
            document.getElementById('saveStatus').innerText = "Error: " + e.message;
            document.getElementById('saveStatus').style.color = "red";
        }
    };
     // --- EXCEL UPLOAD ---
    const EXCEL_COLS = [
        "Amount Billed", "Cash Received", "EFTPOS Received", "Credit Card Received", 
        "Extras Cover Received", "Bank Transfer Received", "Cheque Received", 
        "Deposit Applied", "Bulk Bill Received", "DVA Received", "ECLIPSE Received", 
        "90 Day Gap Received", "Amount Received"
    ];

    document.getElementById('excelFile').onchange = function() {
        const status = document.getElementById('uploadStatus');
        status.style.color = "blue";
        status.innerText = "Processing...";
        const reader = new FileReader();
        
        reader.onload = async function(e) {
            try {
                const wb = XLSX.read(new Uint8Array(e.target.result), {type: 'array'});
                const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { header: 1 });
                
                let date = "", hIdx = -1;
                for(let i=0; i<Math.min(rows.length, 25); i++){
                    const txt = (rows[i]||[]).join(" ");
                    if(txt.includes("Period")){ const m = txt.match(/\d{1,2}\/\d{1,2}\/\d{4}/g); if(m) date=m[0]; }
                    if((rows[i]||[]).includes("Doctor")) hIdx=i;
                }

                const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { range: hIdx });
                const batch = db.batch();
                let count = 0;

                for(const r of json){
                    const keys = Object.keys(r);
                    const findKey = (name) => keys.find(k => k.trim().toLowerCase() === name.toLowerCase());
                    
                    const doc = (r[findKey('Doctor')]||"").toString().trim();
                    
                    if(doc && !doc.includes("Total:")){
                        const loc = r[findKey('Location')]||"N/A";
                        const id = `${date}_${doc}_${loc}`.replace(/\//g,'-').replace(/\s+/g,'_');
                        
                        let dataObj = {
                            reportDate: date,
                            doctorName: doc,
                            location: loc,
                            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                        };

                        EXCEL_COLS.forEach(colName => {
                            const val = r[findKey(colName)];
                            dataObj[colName.replace(/\s+/g, '')] = parseFloat(val) || 0; 
                        });

                        batch.set(db.collection("daily_reports").doc(id), dataObj, {merge:true});
                        count++;
                    }
                }
                await batch.commit();
                status.style.color = "green";
                status.innerText = `‚úî Saved ${count} records`;
                setTimeout(loadAllData, 1000);
            } catch(e) {
                status.style.color = "red";
                status.innerText = "Error: " + e.message;
                console.error(e);
            }
        };
        reader.readAsArrayBuffer(this.files[0]);
    };
    window.deleteRecord = async (id) => { if(confirm("Delete?")) { await db.collection("daily_reports").doc(id).delete(); loadAllData(); }};
</script>
</body>
</html>
