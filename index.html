<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <style>html { display:none; }</style>
    <script>
       if (self == top) {
           document.documentElement.style.display = 'block'; 
       } else {
           top.location = self.location; 
       }
    </script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SA Eye Specialists Portal - V6.0</title>
    <script src="lib/jquery.min.js"></script>
    <script src="lib/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="lib/pivot.min.css">
    <script src="lib/pivot.min.js"></script>
    <script src="lib/tips_data.min.js"></script>

    <script src="lib/firebase-app-compat.js"></script>
    <script src="lib/firebase-auth-compat.js"></script>
    <script src="lib/firebase-firestore-compat.js"></script>

    <script src="lib/xlsx.full.min.js"></script>
    <script src="lib/chart.umd.min.js"></script>
    <script src="lib/jspdf.umd.min.js"></script>
    <script src="lib/jspdf.plugin.autotable.min.js"></script>
    
    <link rel="stylesheet" href="styles.css">
    
</head>
<body>

<img id="pdfLogoSource" src="logo.png" style="display:none;" alt="Logo Source">

<div class="card">
    <div id="loginSection">
        <img src="logo.png" alt="SA Eye Specialists" class="login-logo" onerror="this.style.display='none'; document.getElementById('backupTitle').style.display='block';">
        <h2 id="backupTitle" style="color:#0056b3; display:none;">SA Eye Specialists</h2>
        <p style="color:#666; margin-bottom:25px;">Financial Portal Login</p>
        <input type="email" id="email" class="login-input" placeholder="Email">
        <input type="password" id="password" class="login-input" placeholder="Password">
        <button class="btn btn-primary" style="width:100%; margin-top:15px; padding:15px;" id="loginBtn">Sign In</button>
        <p style="font-size: 10px; color: #ccc; margin-top: 20px;">Build V6.0</p>
    </div>

    <div id="appSection" class="hidden">
        <div class="app-header">
            <div style="display:flex; align-items:center;">
                <img src="logo.png" class="header-logo" alt="Logo">
                <div class="tabs-area">
                    <button class="tab-btn active" id="tabBtnVisuals" onclick="switchTab('visuals')">Financial Dashboard</button>
                    <button class="tab-btn" id="tabBtnAnalysis" onclick="switchTab('analysis')">Financial Analysis</button>                 
                    <button class="tab-btn" id="tabBtnData" onclick="switchTab('data')">Financial Data</button>
                    <button class="tab-btn" id="tabBtnSet" onclick="switchTab('settings')">Doctor Settings (Fees)</button>                    
                </div>
            </div>
            <div class="user-area">
                <span id="userNameDisplay" style="font-size:13px; color:#555; font-weight:600;">Admin</span>
                <button class="logout-btn" onclick="logout()">Sign Out</button>
            </div>
        </div>

        <div id="tab-visuals" class="tab-content active">
            <div class="fy-selector">
                <strong>üìÖ Select Financial Year:</strong>
                <select id="fyDropdown" style="padding:8px; border-radius:4px; font-weight:bold; min-width:150px;">
                    <option>Loading...</option>
                </select>
                <span style="font-size:12px; color:#666; margin-left:10px;">(Jul 1 - Jun 30)</span>
            </div>

            <div style="display:flex; gap:20px; margin-bottom:20px;">
                <div class="stat-card clickable-card" style="flex:1;" onclick="goToDataTabWithFY()">
                    <h3>Total Billings (Click for Data)</h3>
                    <div class="big-num" id="dashTotalRev">$0.00</div>
                    <span style="font-size:11px; color:#0056b3;">View Details &rarr;</span>
                </div>
        
                <div class="stat-card" style="flex:1;">
                    <h3>Total Practice Revenue</h3>
                    <div class="big-num" id="dashPracRev" style="color:#28a745;">$0.00</div>
                    <span style="font-size:11px; color:#666;">Calculated from Commission</span>
                </div>
            </div>

            <div class="dashboard-grid">
                <div class="stat-card">
                    <h3>Billings by Doctor</h3>
                    <canvas id="chartBillBar" style="max-height: 300px;"></canvas>
                </div>
                <div class="stat-card">
                    <h3>Practice Revenue by Doctor</h3>
                    <canvas id="chartPracBar" style="max-height: 300px;"></canvas>
                </div>
            </div>

            <div class="dashboard-grid" style="margin-top: 20px;">
                <div class="stat-card">
                    <h3>Monthly Billing Trend</h3>
                    <canvas id="chartBillLine" style="max-height: 300px;"></canvas>
                </div>
                <div class="stat-card">
                    <h3>Monthly Practice Revenue Trend</h3>
                    <canvas id="chartPracLine" style="max-height: 300px;"></canvas>
                </div>
            </div>
        </div>

        <div id="tab-data" class="tab-content">
            <div class="filter-bar">
                <select id="dataFyFilter" style="padding:8px; border-radius:4px; border:1px solid #ccc; font-weight:bold; background:#e3f2fd;">
                    <option value="">-- All FYs --</option>
                </select>
                
                <select id="monthFilter" style="padding:8px; border-radius:4px;">
                    <option value="">-- All Months --</option>
                </select>
                
                <select id="doctorFilter" style="padding:8px; border-radius:4px; border:1px solid #ccc; min-width: 150px;">
                    <option value="">-- All Doctors --</option>
                </select>
                
                <button class="btn" id="clearFilters" style="background:#6c757d; color:white;">Clear Filters</button>
                
                <div style="flex:1; text-align:right; display:flex; justify-content:flex-end; gap:10px;">
                    <button class="btn btn-purple" onclick="generatePDF()">üìÑ Download PDF Report</button>
                    <input type="file" id="excelFile" class="hidden" accept=".xlsx, .xls">
                    <button class="btn btn-green" onclick="document.getElementById('excelFile').click()">+ Upload Excel</button>
                </div>
            </div>
            
            <p id="uploadStatus" style="text-align:center; font-size:13px; font-weight:bold; height:20px;"></p>

            <div class="table-wrapper">
                <table id="dataTableElement">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Doctor</th>
                            <th>Location</th>
                            <th class="money-col">Billings</th> <th style="text-align:center;">Commission Rate</th> <th class="money-col">Practice Revenue</th> <th class="money-col">GST</th>
                            <th class="money-col">Remittance</th>
                            <th style="text-align:center;">Action</th>
                        </tr>
                    </thead>
                    <tbody id="recordsTableBody"></tbody>
                    <tfoot>
                        <tr class="total-row">
                            <td colspan="3" style="text-align:right;">TOTALS:</td>
                            <td class="money-col" id="totalReceived">$0.00</td><td></td>
                            <td class="money-col" id="totalFee">$0.00</td><td class="money-col" id="totalGST">$0.00</td>
                            <td class="money-col" id="totalRemit">$0.00</td><td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <div id="tab-settings" class="tab-content">
            <div class="settings-container">
                <div class="doctor-list">
                    <h3 style="margin-top:0; font-size:14px; text-transform:uppercase; color:#888;">Doctor List</h3>
                    <div id="doctorListPanel"></div>
                </div>
                <div class="config-panel" id="configPanel" style="display:none;">
                    <h2 id="configTitle" style="margin-top:0; color:#0056b3; border-bottom:2px solid #eee; padding-bottom:15px;"></h2>
                    <div style="background:#f1f3f5; padding:15px; border-radius:8px; margin-bottom:15px;">
                        <strong>üè¶ Bank Details</strong>
                        <div style="display:flex; gap:10px; margin-top:10px;">
                            <input type="text" id="docBSB" placeholder="BSB (e.g. 123-456)" class="login-input" style="margin:0;">
                            <input type="text" id="docAcc" placeholder="Account Number" class="login-input" style="margin:0;">
                        </div>
                    </div>
                    <div class="rule-card">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                            <strong>üìÖ Fee Timeline</strong>
                            <button class="btn btn-primary" style="padding:5px 12px;" onclick="addTimelineRow()">+ Add Period</button>
                        </div>
                        <div id="timelineContainer"></div>
                    </div>
                    <div class="rule-card" style="border-left: 5px solid #ffc107;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                            <strong>‚ö†Ô∏è Monthly Exceptions</strong>
                            <button class="btn btn-primary" style="padding:5px 12px;" onclick="addExceptionRow()">+ Add Exception</button>
                        </div>
                        <div id="exceptionsContainer"></div>
                    </div>
                    <button class="btn btn-green" style="width:100%; padding:15px; font-size:16px;" onclick="saveDoctorSettings()">SAVE SETTINGS</button>
                    <p id="saveStatus" style="text-align:center; font-weight:bold; margin-top:15px; color:green;"></p>
                </div>
                <div id="noDocSelected" style="flex:1; display:flex; align-items:center; justify-content:center; color:#999; font-style:italic;">Select a doctor.</div>
            </div>
        </div>

        <div id="tab-analysis" class="tab-content">
            <div class="analysis-controls">
            <div class="control-group">
                <label class="control-label">üìÇ Load Saved Analysis</label>
                <div style="display: flex; gap: 5px;">
                    <select id="savedReportsDropdown" class="control-input" onchange="loadSelectedReport()">
                        <option value="">-- Select a Report --</option>
                        <option disabled>Loading...</option>
                    </select>
                    <button class="btn btn-danger" onclick="deleteSelectedReport()" style="padding: 0 15px;" title="Delete Selected Report">üóëÔ∏è</button>
                </div>
            </div>
            
            <div class="control-group" style="border-left: 1px solid #ddd; padding-left: 20px;">
                <label class="control-label">üíæ Save Current Analysis</label>
                <div style="display: flex; gap: 5px;">
                    <input type="text" id="newReportName" class="control-input" placeholder="Report Name (e.g. FY25 Revenue)">
                    <button class="btn btn-green" onclick="saveCurrentReport()">Save</button>
                </div>
            </div>
        </div>
            
            <div id="pivotOutput" style="overflow-x: auto; min-height: 500px;">
                <div style="padding: 40px; text-align: center; color: #999;">Loading Analysis Tools...</div>
            </div>
        </div>
        
        <div class="version-display">
            <span>Build Version: 6.0</span>
            <span id="dbStatus">System Status: Ready</span>
        </div>
    </div>
</div>

<div id="customModal" class="modal-overlay">
    <div class="modal-box">
        <h3 id="modalTitle" class="modal-title">Alert</h3>
        <p id="modalMsg" class="modal-msg">Message goes here.</p>
        <div id="modalActions" class="modal-actions">
            </div>
    </div>
</div>
    
<script src="script.js"></script>
    
</body>
</html>
