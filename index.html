<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SA Eye Specialists Portal - V2.2</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; display: flex; justify-content: center; }
        .card { background: white; padding: 0; border-radius: 15px; box-shadow: 0 8px 24px rgba(0,0,0,0.1); width: 100%; max-width: 1200px; position: relative; overflow: hidden; min-height: 85vh; display: flex; flex-direction: column; }
        
        /* HEADER & TABS */
        .app-header { background: #fff; border-bottom: 1px solid #dee2e6; display: flex; justify-content: space-between; align-items: center; padding: 0; }
        .tabs-area { display: flex; flex: 1; }
        .tab-btn { padding: 20px 25px; border: none; background: none; cursor: pointer; font-size: 15px; font-weight: 600; color: #6c757d; border-bottom: 3px solid transparent; transition: 0.2s; }
        .tab-btn:hover { background: #f8f9fa; color: #0056b3; }
        .tab-btn.active { color: #0056b3; border-bottom: 3px solid #0056b3; background: #fff; }
        
        .user-area { padding: 0 20px; display: flex; align-items: center; gap: 15px; border-left: 1px solid #eee; height: 100%; }
        .logout-btn { color: #dc3545; background: #fff0f0; border: 1px solid #ffc9c9; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 13px; }
        .logout-btn:hover { background: #dc3545; color: white; border-color: #dc3545; }

        /* CONTENT */
        .tab-content { display: none; padding: 30px; flex: 1; }
        .tab-content.active { display: block; }
        
        /* DASHBOARD UI */
        .filter-bar { background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 20px; display: flex; gap: 12px; align-items: center; border: 1px solid #eee; flex-wrap: wrap; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 10px; }
        th { background: #f1f3f5; padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6; white-space: nowrap; }
        td { padding: 12px; border-bottom: 1px solid #eee; }
        .money-col { text-align: right; font-family: 'Courier New', monospace; font-weight: 600; }
        .total-row { font-weight: bold; background: #e7f3ff; font-size: 14px; }

        /* SETTINGS UI */
        .settings-container { display: flex; gap: 30px; height: 100%; min-height: 500px; border-top: 1px solid #f0f0f0; padding-top: 20px; }
        .doctor-list { width: 280px; border-right: 1px solid #eee; padding-right: 20px; overflow-y: auto; max-height: 600px; }
        .doctor-item { padding: 12px; border-radius: 8px; cursor: pointer; margin-bottom: 8px; border: 1px solid transparent; background: #fcfcfc; transition: 0.2s; }
        .doctor-item:hover { background: #f0f2f5; border-color: #ddd; }
        .doctor-item.selected { background: #e7f1ff; color: #0056b3; font-weight: bold; border-color: #0056b3; }
        
        .config-panel { flex: 1; padding: 10px; }
        .rule-card { border: 1px solid #ddd; padding: 20px; border-radius: 10px; margin-bottom: 20px; background: #fff; }
        .input-group { display: flex; gap: 10px; margin-bottom: 12px; align-items: center; background: #f8f9fa; padding: 10px; border-radius: 6px; }

        /* UTILS */
        .btn { padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: bold; }
        .btn-primary { background-color: #0056b3; color: white; }
        .btn-green { background-color: #28a745; color: white; }
        .btn-danger { background-color: #dc3545; color: white; padding: 5px 10px; }
        .hidden { display: none; }
        .version-display { padding: 10px 20px; font-size: 11px; color: #999; border-top: 1px solid #eee; background: #fdfdfd; display: flex; justify-content: space-between; }
    </style>
</head>
<body>

<div class="card">
    <div id="loginSection" style="padding: 60px 30px; text-align: center; max-width: 400px; margin: auto;">
        <h2 style="color:#0056b3;">SA Eye Specialists</h2>
        <p style="color:#666; margin-bottom:25px;">Financial Management Portal</p>
        <input type="email" id="email" placeholder="Email Address" style="width:100%; padding:12px; margin:8px 0; border:1px solid #ddd; border-radius:6px; box-sizing:border-box;">
        <input type="password" id="password" placeholder="Password" style="width:100%; padding:12px; margin:8px 0; border:1px solid #ddd; border-radius:6px; box-sizing:border-box;">
        <button class="btn btn-primary" style="width:100%; margin-top:15px; padding:15px;" id="loginBtn">Sign In</button>
    </div>

    <div id="appSection" class="hidden">
        <div class="app-header">
            <div class="tabs-area">
                <button class="tab-btn active" id="tabBtnDash" onclick="switchTab('dashboard')">Financial Dashboard</button>
                <button class="tab-btn" id="tabBtnSet" onclick="switchTab('settings')">Doctor Settings (Fees)</button>
            </div>
            <div class="user-area">
                <span id="userNameDisplay" style="font-size:13px; color:#555; font-weight:600;">Admin</span>
                <button class="logout-btn" onclick="logout()">Sign Out</button>
            </div>
        </div>

        <div id="tab-dashboard" class="tab-content active">
            <div class="filter-bar">
                <select id="monthFilter" style="padding:8px; border-radius:4px;"><option value="">-- All Time --</option></select>
                <input type="date" id="dateFilter" style="padding:8px; border:1px solid #ccc; border-radius:4px;">
                <input type="text" id="doctorFilter" placeholder="Search Doctor..." style="padding:8px; border:1px solid #ccc; border-radius:4px;">
                <button class="btn btn-primary" id="applyFilters">Apply Filters</button>
                <button class="btn" id="clearFilters" style="background:#6c757d; color:white;">Clear</button>
                <div style="flex:1; text-align:right;">
                    <input type="file" id="excelFile" class="hidden" accept=".xlsx, .xls">
                    <button class="btn btn-green" onclick="document.getElementById('excelFile').click()">+ Upload Excel</button>
                </div>
            </div>
            <p id="uploadStatus" style="text-align:center; font-size:13px; font-weight:bold; height:20px;"></p>

            <div style="overflow-x:auto;">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Doctor</th>
                            <th>Location</th>
                            <th class="money-col">Received</th>
                            <th style="text-align:center;">Rate</th>
                            <th class="money-col">Service Fee</th>
                            <th class="money-col">GST</th>
                            <th class="money-col">Remittance</th>
                            <th style="text-align:center;">Action</th>
                        </tr>
                    </thead>
                    <tbody id="recordsTableBody"></tbody>
                    <tfoot>
                        <tr class="total-row">
                            <td colspan="3" style="text-align:right;">TOTALS:</td>
                            <td class="money-col" id="totalReceived">$0.00</td>
                            <td></td>
                            <td class="money-col" id="totalFee">$0.00</td>
                            <td class="money-col" id="totalGST">$0.00</td>
                            <td class="money-col" id="totalRemit">$0.00</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <div id="tab-settings" class="tab-content">
            <div class="settings-container">
                <div class="doctor-list">
                    <h3 style="margin-top:0; font-size:14px; text-transform:uppercase; color:#888; letter-spacing:1px;">Doctor List</h3>
                    <div id="doctorListPanel">
                        <p style="color:#999; font-style:italic;">Loading...</p>
                    </div>
                </div>

                <div class="config-panel" id="configPanel" style="display:none;">
                    <h2 id="configTitle" style="margin-top:0; color:#0056b3; border-bottom:2px solid #eee; padding-bottom:15px;"></h2>
                    
                    <div class="rule-card">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                            <strong style="font-size:15px;">üìÖ Fee Timeline (Standard Rates)</strong>
                            <button class="btn btn-primary" style="padding:5px 12px;" onclick="addTimelineRow()">+ Add Period</button>
                        </div>
                        <div id="timelineContainer"></div>
                    </div>

                    <div class="rule-card" style="border-left: 5px solid #ffc107;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                            <strong style="font-size:15px;">‚ö†Ô∏è One-off Monthly Exceptions</strong>
                            <button class="btn btn-primary" style="padding:5px 12px;" onclick="addExceptionRow()">+ Add Exception</button>
                        </div>
                        <div id="exceptionsContainer"></div>
                    </div>

                    <button class="btn btn-green" style="width:100%; padding:15px; font-size:16px;" onclick="saveDoctorSettings()">SAVE SETTINGS</button>
                    <p id="saveStatus" style="text-align:center; font-weight:bold; margin-top:15px; color:green;"></p>
                </div>
                <div id="noDocSelected" style="flex:1; display:flex; align-items:center; justify-content:center; color:#999; font-style:italic;">
                    Select a doctor from the list to view or edit fees.
                </div>
            </div>
        </div>
        
        <div class="version-display">
            <span>Build Version: 2.2</span>
            <span id="dbStatus">System Status: Disconnected</span>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAsCKNyHipM5kUKKqJ_klJ1J1l20E4iQ-k",
        authDomain: "saeyespecialists-portal.firebaseapp.com",
        projectId: "saeyespecialists-portal",
        storageBucket: "saeyespecialists-portal.firebasestorage.app",
        messagingSenderId: "584706843504",
        appId: "1:584706843504:web:9b7e3e5307f162de55e5b5"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let allRecords = [];
    let doctorSettingsMap = {};
    let currentEditingDoc = null;

    const formatCurr = (n) => new Intl.NumberFormat('en-AU', { style: 'currency', currency: 'AUD' }).format(n);
    const parseDate = (str) => { if(!str) return new Date(0); const [d,m,y] = str.split('/'); return new Date(`${y}-${m}-${d}`); };

    // AUTH
    document.getElementById('loginBtn').onclick = () => auth.signInWithEmailAndPassword(document.getElementById('email').value, document.getElementById('password').value).catch(e => alert(e.message));
    window.logout = () => auth.signOut().then(() => location.reload());

    auth.onAuthStateChanged(user => {
        if (user) {
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('appSection').classList.remove('hidden');
            // Get user name
            db.collection("users").doc(user.uid).get().then(doc => {
                if(doc.exists) document.getElementById('userNameDisplay').innerText = doc.data().name;
            });
            loadAllData();
        }
    });

    // DATA LOADING (The Fix for Legacy Data)
    async function loadAllData() {
        const dbStat = document.getElementById('dbStatus');
        dbStat.innerText = "System Status: Syncing Data...";
        
        try {
            // 1. Load Settings
            const sSnap = await db.collection("doctor_settings").get();
            doctorSettingsMap = {};
            sSnap.forEach(doc => doctorSettingsMap[doc.id] = doc.data());

            // 2. Load Records (WITHOUT sorting on server to catch old data)
            const rSnap = await db.collection("daily_reports").get();
            
            allRecords = [];
            rSnap.forEach(doc => {
                let d = doc.data(); 
                d.id = doc.id; 
                d.jsDate = parseDate(d.reportDate);
                allRecords.push(d);
            });

            dbStat.innerText = `System Status: Online | Loaded ${allRecords.length} records.`;
            
            // 3. Render
            populateMonthDropdown();
            renderDashboard(allRecords);
            renderDoctorList();
        } catch (err) {
            dbStat.innerText = "System Status: Error - " + err.message;
            console.error(err);
        }
    }

    // DASHBOARD RENDER
    function renderDashboard(data) {
        const tbody = document.getElementById('recordsTableBody');
        tbody.innerHTML = "";
        let tRec=0, tFee=0, tGST=0, tRem=0;

        // Sort Client Side (Safe)
        data.sort((a,b) => b.jsDate - a.jsDate);

        data.forEach(d => {
            const {rate, isEx} = getRate(d.doctorName, d.jsDate);
            const fee = d.amountReceived * (rate / 100);
            const gst = fee * 0.10;
            const remit = d.amountReceived - (fee + gst);

            tRec += d.amountReceived; tFee += fee; tGST += gst; tRem += remit;

            const badge = isEx ? `<span style="background:#fff3cd; color:#856404; padding:2px 6px; border-radius:4px; font-size:11px;">${rate}% (Ex)</span>` 
                               : `<span style="background:#e7f1ff; color:#0056b3; padding:2px 6px; border-radius:4px; font-size:11px;">${rate}%</span>`;

            tbody.innerHTML += `<tr>
                <td>${d.reportDate}</td>
                <td style="font-weight:600; color:#333;">${d.doctorName}</td>
                <td style="color:#666;">${d.location}</td>
                <td class="money-col">${formatCurr(d.amountReceived)}</td>
                <td style="text-align:center;">${badge}</td>
                <td class="money-col">${formatCurr(fee)}</td>
                <td class="money-col">${formatCurr(gst)}</td>
                <td class="money-col" style="color:#28a745;">${formatCurr(remit)}</td>
                <td style="text-align:center;"><button class="btn btn-danger" style="font-size:10px; padding:4px 8px;" onclick="deleteRecord('${d.id}')">Del</button></td>
            </tr>`;
        });

        document.getElementById('totalReceived').innerText = formatCurr(tRec);
        document.getElementById('totalFee').innerText = formatCurr(tFee);
        document.getElementById('totalGST').innerText = formatCurr(tGST);
        document.getElementById('totalRemit').innerText = formatCurr(tRem);
    }

    // DOCTOR SETTINGS
    function renderDoctorList() {
        // Extract unique doctors
        const doctors = [...new Set(allRecords.map(r => r.doctorName))].sort();
        const panel = document.getElementById('doctorListPanel');
        
        if (doctors.length === 0) {
            panel.innerHTML = "<p style='color:#999; font-size:13px; padding:10px;'>No doctors found.<br>Upload an Excel file to start.</p>";
            return;
        }

        panel.innerHTML = "";
        doctors.forEach(name => {
            const div = document.createElement('div');
            div.className = "doctor-item";
            div.innerText = name;
            div.onclick = () => {
                document.querySelectorAll('.doctor-item').forEach(i => i.classList.remove('selected'));
                div.classList.add('selected');
                openConfig(name);
            };
            panel.appendChild(div);
        });
    }

    function openConfig(name) {
        currentEditingDoc = name;
        document.getElementById('noDocSelected').style.display = 'none';
        document.getElementById('configPanel').style.display = 'block';
        document.getElementById('configTitle').innerText = name;
        
        const set = doctorSettingsMap[name] || { timeline: [], exceptions: {} };
        document.getElementById('timelineContainer').innerHTML = "";
        document.getElementById('exceptionsContainer').innerHTML = "";

        (set.timeline || []).forEach(r => addTimelineRow(r.startDate, r.fee));
        Object.entries(set.exceptions || {}).forEach(([m, f]) => addExceptionRow(m, f));
    }

    function getRate(docName, jsDate) {
        const set = doctorSettingsMap[docName];
        if(!set) return { rate: 0, isEx: false }; // Default 0% if not set
        
        const mStr = jsDate.toLocaleString('default', { month: 'short', year: 'numeric' });
        if(set.exceptions && set.exceptions[mStr] !== undefined) return { rate: parseFloat(set.exceptions[mStr]), isEx: true };
        
        if(set.timeline && set.timeline.length > 0) {
            const sorted = [...set.timeline].sort((a,b) => new Date(b.startDate) - new Date(a.startDate));
            const rule = sorted.find(r => new Date(r.startDate) <= jsDate);
            if(rule) return { rate: parseFloat(rule.fee), isEx: false };
        }
        return { rate: 0, isEx: false };
    }

    // HELPER FUNCTIONS
    window.switchTab = (tab) => {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`tab-${tab}`).classList.add('active');
        document.getElementById(tab === 'dashboard' ? 'tabBtnDash' : 'tabBtnSet').classList.add('active');
    };

    window.addTimelineRow = (d="", f="") => {
        const div = document.createElement('div');
        div.className = "input-group";
        div.innerHTML = `<label style="font-size:12px; width:40px;">From:</label><input type="date" class="tl-d" value="${d}"><label style="font-size:12px;">Fee%:</label><input type="number" class="tl-f" value="${f}" style="width:60px;"><button class="btn btn-danger" style="padding:4px 8px;" onclick="this.parentElement.remove()">√ó</button>`;
        document.getElementById('timelineContainer').appendChild(div);
    };

    window.addExceptionRow = (m="", f="") => {
        const div = document.createElement('div');
        div.className = "input-group";
        div.innerHTML = `<input type="text" class="ex-m" value="${m}" placeholder="e.g. Nov 2025"><label style="font-size:12px;">Fee%:</label><input type="number" class="ex-f" value="${f}" style="width:60px;"><button class="btn btn-danger" style="padding:4px 8px;" onclick="this.parentElement.remove()">√ó</button>`;
        document.getElementById('exceptionsContainer').appendChild(div);
    };

    window.saveDoctorSettings = async () => {
        const tl = []; document.querySelectorAll('.tl-d').forEach((el, i) => { const f = document.querySelectorAll('.tl-f')[i].value; if(el.value && f) tl.push({ startDate: el.value, fee: f }); });
        const ex = {}; document.querySelectorAll('.ex-m').forEach((el, i) => { const f = document.querySelectorAll('.ex-f')[i].value; if(el.value && f) ex[el.value] = f; });
        await db.collection("doctor_settings").doc(currentEditingDoc).set({ timeline: tl, exceptions: ex });
        const status = document.getElementById('saveStatus');
        status.innerText = "‚úî Saved Successfully!";
        setTimeout(() => status.innerText = "", 2000);
        loadAllData();
    };
    
    // EXCEL UPLOAD
    document.getElementById('excelFile').onchange = function() {
        const status = document.getElementById('uploadStatus');
        status.style.color = "blue"; status.innerText = "Processing...";
        const reader = new FileReader();
        reader.onload = async function(e) {
            try {
                const wb = XLSX.read(new Uint8Array(e.target.result), {type: 'array'});
                const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { header: 1 });
                let date = "", hIdx = -1;
                for(let i=0; i<20; i++){
                    const txt = (rows[i]||[]).join(" ");
                    if(txt.includes("Period")){ const m = txt.match(/\d{1,2}\/\d{1,2}\/\d{4}/g); if(m) date=m[0]; }
                    if((rows[i]||[]).includes("Doctor")) hIdx=i;
                }
                const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { range: hIdx });
                let count = 0;
                for(const r of json){
                    const keys = Object.keys(r);
                    const doc = (r[keys.find(k=>k.trim()==='Doctor')]||"").toString().trim();
                    if(doc && !doc.includes("Total:")){
                        const loc = r[keys.find(k=>k.trim()==='Location')]||"N/A";
                        const id = `${date}_${doc}_${loc}`.replace(/\//g,'-').replace(/\s+/g,'_');
                        await db.collection("daily_reports").doc(id).set({
                            reportDate: date, doctorName: doc, location: loc,
                            amountBilled: parseFloat(r[keys.find(k=>k.trim()==='Amount Billed')])||0,
                            amountReceived: parseFloat(r[keys.find(k=>k.trim()==='Amount Received')])||0,
                            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                        }, {merge:true});
                        count++;
                    }
                }
                status.style.color = "green"; status.innerText = `‚úî ${count} Records Synced!`;
                loadAllData();
            } catch(e) { status.style.color="red"; status.innerText=e.message; }
        };
        reader.readAsArrayBuffer(this.files[0]);
    };

    function populateMonthDropdown() {
        const months = [...new Set(allRecords.map(r => r.jsDate.toLocaleString('default', { month: 'short', year: 'numeric' })))].sort((a,b) => new Date(b) - new Date(a));
        const sel = document.getElementById('monthFilter');
        sel.innerHTML = '<option value="">-- All Time --</option>';
        months.forEach(m => sel.innerHTML += `<option value="${m}">${m}</option>`);
    }

    document.getElementById('applyFilters').onclick = () => {
        const m = document.getElementById('monthFilter').value;
        const d = document.getElementById('dateFilter').value;
        const doc = document.getElementById('doctorFilter').value.toLowerCase();
        const filtered = allRecords.filter(r => {
            const matchM = !m || r.jsDate.toLocaleString('default', { month: 'short', year: 'numeric' }) === m;
            const matchD = !d || r.reportDate === d.split('-').reverse().join('/');
            const matchDoc = !doc || r.doctorName.toLowerCase().includes(doc);
            return matchM && matchD && matchDoc;
        });
        renderDashboard(filtered);
    };

    document.getElementById('clearFilters').onclick = () => {
        document.getElementById('monthFilter').value = ""; document.getElementById('dateFilter').value = ""; document.getElementById('doctorFilter').value = "";
        renderDashboard(allRecords);
    };
    
    window.deleteRecord = async (id) => { if(confirm("Delete record?")) { await db.collection("daily_reports").doc(id).delete(); loadAllData(); }};
</script>
</body>
</html>
