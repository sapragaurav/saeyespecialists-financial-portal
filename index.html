<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SA Eye Specialists Portal - V2.8</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; display: flex; justify-content: center; }
        .card { background: white; padding: 0; border-radius: 15px; box-shadow: 0 8px 24px rgba(0,0,0,0.1); width: 100%; max-width: 1250px; position: relative; overflow: hidden; min-height: 85vh; display: flex; flex-direction: column; }
        
        /* LOGIN */
        #loginSection { padding: 60px 30px; text-align: center; max-width: 400px; margin: auto; }
        .login-input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }

        /* HEADER & TABS */
        .app-header { background: #fff; border-bottom: 1px solid #dee2e6; display: flex; justify-content: space-between; align-items: center; padding: 0; }
        .tabs-area { display: flex; flex: 1; }
        .tab-btn { padding: 20px 25px; border: none; background: none; cursor: pointer; font-size: 15px; font-weight: 600; color: #6c757d; border-bottom: 3px solid transparent; transition: 0.2s; }
        .tab-btn:hover { background: #f8f9fa; color: #0056b3; }
        .tab-btn.active { color: #0056b3; border-bottom: 3px solid #0056b3; background: #fff; }
        
        .user-area { padding: 0 20px; display: flex; align-items: center; gap: 15px; border-left: 1px solid #eee; height: 100%; }
        .logout-btn { color: #dc3545; background: #fff0f0; border: 1px solid #ffc9c9; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 13px; }

        /* CONTENT AREAS */
        .tab-content { display: none; padding: 30px; flex: 1; overflow-y: auto; }
        .tab-content.active { display: block; }
        
        /* DASHBOARD (GRAPHS) */
        .fy-selector { background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; border: 1px solid #bbdefb; }
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .stat-card { background: #fff; border: 1px solid #eee; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); transition: transform 0.2s; }
        .stat-card h3 { margin-top: 0; color: #555; font-size: 14px; text-transform: uppercase; }
        .big-num { font-size: 28px; font-weight: bold; color: #0056b3; margin: 10px 0; }
        
        .clickable-card { cursor: pointer; border: 1px solid #b3d7ff; }
        .clickable-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,86,179,0.15); }

        /* DATA TABLE */
        .filter-bar { background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 20px; display: flex; gap: 12px; align-items: center; border: 1px solid #eee; flex-wrap: wrap; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 10px; }
        th { background: #f1f3f5; padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6; }
        td { padding: 12px; border-bottom: 1px solid #eee; }
        .money-col { text-align: right; font-family: 'Courier New', monospace; font-weight: 600; }
        .total-row { font-weight: bold; background: #e7f3ff; font-size: 14px; }

        /* SETTINGS */
        .settings-container { display: flex; gap: 30px; height: 100%; min-height: 500px; border-top: 1px solid #f0f0f0; padding-top: 20px; }
        .doctor-list { width: 280px; border-right: 1px solid #eee; padding-right: 20px; overflow-y: auto; }
        .doctor-item { padding: 12px; border-radius: 8px; cursor: pointer; margin-bottom: 8px; border: 1px solid transparent; background: #fcfcfc; transition: 0.2s; }
        .doctor-item.selected { background: #e7f1ff; color: #0056b3; font-weight: bold; border-color: #0056b3; }
        .input-group { display: flex; gap: 10px; margin-bottom: 12px; align-items: center; background: #f8f9fa; padding: 10px; border-radius: 6px; }

        /* UTILS */
        .btn { padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: bold; }
        .btn-primary { background-color: #0056b3; color: white; }
        .btn-green { background-color: #28a745; color: white; }
        .btn-danger { background-color: #dc3545; color: white; padding: 5px 10px; }
        .hidden { display: none; }
        .version-display { padding: 10px 20px; font-size: 11px; color: #999; border-top: 1px solid #eee; background: #fdfdfd; display: flex; justify-content: space-between; }
    </style>
</head>
<body>

<div class="card">
    <div id="loginSection">
        <h2 style="color:#0056b3;">SA Eye Specialists</h2>
        <p style="color:#666; margin-bottom:25px;">Financial Portal Login</p>
        <input type="email" id="email" class="login-input" placeholder="Email">
        <input type="password" id="password" class="login-input" placeholder="Password">
        <button class="btn btn-primary" style="width:100%; margin-top:15px; padding:15px;" id="loginBtn">Sign In</button>
        <p style="font-size: 10px; color: #ccc; margin-top: 20px;">Build V2.8</p>
    </div>

    <div id="appSection" class="hidden">
        <div class="app-header">
            <div class="tabs-area">
                <button class="tab-btn active" id="tabBtnVisuals" onclick="switchTab('visuals')">Financial Dashboard</button>
                <button class="tab-btn" id="tabBtnData" onclick="switchTab('data')">Financial Data</button>
                <button class="tab-btn" id="tabBtnSet" onclick="switchTab('settings')">Doctor Settings (Fees)</button>
            </div>
            <div class="user-area">
                <span id="userNameDisplay" style="font-size:13px; color:#555; font-weight:600;">Admin</span>
                <button class="logout-btn" onclick="logout()">Sign Out</button>
            </div>
        </div>

        <div id="tab-visuals" class="tab-content active">
            <div class="fy-selector">
                <strong>üìÖ Select Financial Year:</strong>
                <select id="fyDropdown" style="padding:8px; border-radius:4px; font-weight:bold; min-width:150px;">
                    <option>Loading...</option>
                </select>
                <span style="font-size:12px; color:#666; margin-left:10px;">(Jul 1 - Jun 30)</span>
            </div>

            <div style="display:flex; gap:20px; margin-bottom:20px;">
                <div class="stat-card clickable-card" style="flex:1;" onclick="goToDataTabWithFY()">
                    <h3>Total Revenue (Click for Data)</h3>
                    <div class="big-num" id="dashTotalRev">$0.00</div>
                    <span style="font-size:11px; color:#0056b3;">View Details &rarr;</span>
                </div>
                <div class="stat-card" style="flex:1;">
                    <h3>Active Doctors (Selected FY)</h3>
                    <div class="big-num" id="dashDocCount">0</div>
                </div>
            </div>

            <div class="dashboard-grid">
                <div class="stat-card">
                    <h3>Revenue by Doctor</h3>
                    <canvas id="doctorChart" style="max-height: 300px;"></canvas>
                </div>
                <div class="stat-card">
                    <h3>Monthly Trend by Doctor</h3>
                    <canvas id="trendChart" style="max-height: 300px;"></canvas>
                </div>
            </div>
        </div>

        <div id="tab-data" class="tab-content">
            <div class="filter-bar">
                <select id="dataFyFilter" style="padding:8px; border-radius:4px; border:1px solid #ccc; font-weight:bold; background:#e3f2fd;">
                    <option value="">-- All FYs --</option>
                </select>

                <select id="monthFilter" style="padding:8px; border-radius:4px;"><option value="">-- All Months --</option></select>
                
                <input type="date" id="dateFilter" style="padding:8px; border:1px solid #ccc; border-radius:4px;">
                <input type="text" id="doctorFilter" placeholder="Search Doctor..." style="padding:8px; border:1px solid #ccc; border-radius:4px;">
                
                <button class="btn btn-primary" id="applyFilters">Apply Filters</button>
                <button class="btn" id="clearFilters" style="background:#6c757d; color:white;">Clear</button>
                
                <div style="flex:1; text-align:right;">
                    <input type="file" id="excelFile" class="hidden" accept=".xlsx, .xls">
                    <button class="btn btn-green" onclick="document.getElementById('excelFile').click()">+ Upload Excel</button>
                </div>
            </div>
            <p id="uploadStatus" style="text-align:center; font-size:13px; font-weight:bold; height:20px;"></p>

            <div style="overflow-x:auto;">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th><th>Doctor</th><th>Location</th><th class="money-col">Received</th>
                            <th style="text-align:center;">Rate</th><th class="money-col">Service Fee</th>
                            <th class="money-col">GST</th><th class="money-col">Remittance</th><th style="text-align:center;">Action</th>
                        </tr>
                    </thead>
                    <tbody id="recordsTableBody"></tbody>
                    <tfoot>
                        <tr class="total-row">
                            <td colspan="3" style="text-align:right;">TOTALS:</td>
                            <td class="money-col" id="totalReceived">$0.00</td><td></td>
                            <td class="money-col" id="totalFee">$0.00</td><td class="money-col" id="totalGST">$0.00</td>
                            <td class="money-col" id="totalRemit">$0.00</td><td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <div id="tab-settings" class="tab-content">
            <div class="settings-container">
                <div class="doctor-list">
                    <h3 style="margin-top:0; font-size:14px; text-transform:uppercase; color:#888;">Doctor List</h3>
                    <div id="doctorListPanel"></div>
                </div>
                <div class="config-panel" id="configPanel" style="display:none;">
                    <h2 id="configTitle" style="margin-top:0; color:#0056b3; border-bottom:2px solid #eee; padding-bottom:15px;"></h2>
                    <div class="rule-card">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                            <strong>üìÖ Fee Timeline</strong>
                            <button class="btn btn-primary" style="padding:5px 12px;" onclick="addTimelineRow()">+ Add Period</button>
                        </div>
                        <div id="timelineContainer"></div>
                    </div>
                    <div class="rule-card" style="border-left: 5px solid #ffc107;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                            <strong>‚ö†Ô∏è Monthly Exceptions</strong>
                            <button class="btn btn-primary" style="padding:5px 12px;" onclick="addExceptionRow()">+ Add Exception</button>
                        </div>
                        <div id="exceptionsContainer"></div>
                    </div>
                    <button class="btn btn-green" style="width:100%; padding:15px; font-size:16px;" onclick="saveDoctorSettings()">SAVE SETTINGS</button>
                    <p id="saveStatus" style="text-align:center; font-weight:bold; margin-top:15px; color:green;"></p>
                </div>
                <div id="noDocSelected" style="flex:1; display:flex; align-items:center; justify-content:center; color:#999; font-style:italic;">Select a doctor.</div>
            </div>
        </div>
        
        <div class="version-display">
            <span>Build Version: 2.8</span>
            <span id="dbStatus">System Status: Ready</span>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAsCKNyHipM5kUKKqJ_klJ1J1l20E4iQ-k",
        authDomain: "saeyespecialists-portal.firebaseapp.com",
        projectId: "saeyespecialists-portal",
        storageBucket: "saeyespecialists-portal.firebasestorage.app",
        messagingSenderId: "584706843504",
        appId: "1:584706843504:web:9b7e3e5307f162de55e5b5"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let allRecords = [];
    let doctorSettingsMap = {};
    let charts = {}; 
    // CONSISTENT COLORS for Doctors
    const DOCTOR_COLORS = ['#0056b3', '#28a745', '#dc3545', '#ffc107', '#17a2b8', '#6610f2', '#fd7e14', '#20c997', '#e83e8c', '#6f42c1'];

    const formatCurr = (n) => new Intl.NumberFormat('en-AU', { style: 'currency', currency: 'AUD' }).format(n);
    const parseDate = (str) => { if(!str) return new Date(0); const [d,m,y] = str.split('/'); return new Date(`${y}-${m}-${d}`); };

    // --- AUTH ---
    const loginFunc = () => auth.signInWithEmailAndPassword(document.getElementById('email').value, document.getElementById('password').value).catch(e => alert(e.message));
    document.getElementById('loginBtn').onclick = loginFunc;
    document.getElementById('password').addEventListener("keypress", (e) => { if(e.key === "Enter") loginFunc(); });
    window.logout = () => auth.signOut().then(() => location.reload());

    auth.onAuthStateChanged(user => {
        if (user) {
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('appSection').classList.remove('hidden');
            loadAllData();
        }
    });

    // --- FY HELPER ---
    function getFinancialYear(dateObj) {
        const year = dateObj.getFullYear();
        const month = dateObj.getMonth(); 
        const fyEndYear = month >= 6 ? year + 1 : year;
        const fyStartYear = fyEndYear - 1;
        return `FY${fyStartYear.toString().substr(2)}/${fyEndYear.toString().substr(2)}`; 
    }

    // --- LOAD DATA ---
    async function loadAllData() {
        document.getElementById('dbStatus').innerText = "Status: Loading...";
        try {
            const sSnap = await db.collection("doctor_settings").get();
            doctorSettingsMap = {};
            sSnap.forEach(doc => doctorSettingsMap[doc.id] = doc.data());

            const rSnap = await db.collection("daily_reports").get();
            allRecords = [];
            rSnap.forEach(doc => { let d = doc.data(); d.id = doc.id; d.jsDate = parseDate(d.reportDate); allRecords.push(d); });

            document.getElementById('dbStatus').innerText = `Status: Online | ${allRecords.length} Records`;
            
            initFYDropdowns();
            populateMonthDropdown();
            renderDashboard(allRecords); 
            renderDoctorList();
        } catch (err) {
            document.getElementById('dbStatus').innerText = "Error: " + err.message;
        }
    }

    // --- DROPDOWNS & FILTER LOGIC ---
    function initFYDropdowns() {
        const fySet = new Set();
        allRecords.forEach(r => fySet.add(getFinancialYear(r.jsDate)));
        const sortedFY = Array.from(fySet).sort().reverse();

        // Dashboard Dropdown
        const selDash = document.getElementById('fyDropdown');
        selDash.innerHTML = "";
        if (sortedFY.length === 0) selDash.innerHTML = "<option>No Data</option>";
        sortedFY.forEach(fy => selDash.innerHTML += `<option value="${fy}">${fy}</option>`);
        
        // Data Tab Dropdown
        const selData = document.getElementById('dataFyFilter');
        selData.innerHTML = '<option value="">-- All FYs --</option>';
        sortedFY.forEach(fy => selData.innerHTML += `<option value="${fy}">${fy}</option>`);

        // Events
        selDash.onchange = renderVisuals;
        selData.onchange = populateMonthDropdown;

        renderVisuals();
    }

    function populateMonthDropdown() {
        const selectedFY = document.getElementById('dataFyFilter').value;
        const sel = document.getElementById('monthFilter');
        let relevantRecords = allRecords;
        if (selectedFY) relevantRecords = allRecords.filter(r => getFinancialYear(r.jsDate) === selectedFY);
        const months = [...new Set(relevantRecords.map(r => r.jsDate.toLocaleString('default', { month: 'short', year: 'numeric' })))];
        months.sort((a,b) => new Date(b) - new Date(a));
        sel.innerHTML = '<option value="">-- All Months --</option>';
        months.forEach(m => sel.innerHTML += `<option value="${m}">${m}</option>`);
    }

    // *** NEW: TOTAL REVENUE DRILL-DOWN ***
    window.goToDataTabWithFY = function() {
        const activeFY = document.getElementById('fyDropdown').value;
        if(activeFY && activeFY !== "No Data") {
            switchTab('data');
            document.getElementById('dataFyFilter').value = activeFY;
            populateMonthDropdown(); // Refresh months based on FY
            document.getElementById('applyFilters').click();
        }
    };

    // --- DASHBOARD CHARTS ---
    function renderVisuals() {
        const selectedFY = document.getElementById('fyDropdown').value;
        if(!allRecords.length || selectedFY === "No Data") return;

        const fyRecords = allRecords.filter(r => getFinancialYear(r.jsDate) === selectedFY);

        // Stats
        const totalRev = fyRecords.reduce((acc, r) => acc + r.amountReceived, 0);
        const uniqueDocs = [...new Set(fyRecords.map(r => r.doctorName))];
        document.getElementById('dashTotalRev').innerText = formatCurr(totalRev);
        document.getElementById('dashDocCount').innerText = uniqueDocs.length;
        
        // Data Prep
        const revByDoc = {};
        const monthKeys = ["Jul", "Aug", "Sep", "Oct", "Nov", "Dec", "Jan", "Feb", "Mar", "Apr", "May", "Jun"];
        const docTrends = {}; 

        fyRecords.forEach(r => {
            revByDoc[r.doctorName] = (revByDoc[r.doctorName] || 0) + r.amountReceived;
            if(!docTrends[r.doctorName]) docTrends[r.doctorName] = Array(12).fill(0);
            const mIndex = r.jsDate.getMonth(); 
            let fyIndex = (mIndex + 6) % 12; 
            docTrends[r.doctorName][fyIndex] += r.amountReceived;
        });

        const docNames = Object.keys(revByDoc);

        // *** NEW: UNIFIED COLOR LOGIC ***
        // Assign a specific color to each doctor based on order, reuse in both charts
        const docColors = docNames.map((name, i) => DOCTOR_COLORS[i % DOCTOR_COLORS.length]);

        // Chart 1: Bar (Revenue by Doctor) - NOW MULTI-COLORED matching Line Chart
        createChart('doctorChart', 'bar', docNames, [{
            label: 'Revenue', 
            data: Object.values(revByDoc), 
            backgroundColor: docColors 
        }], 'bar'); 

        // Chart 2: Line (Monthly Trend)
        const trendDatasets = Object.keys(docTrends).map((docName, i) => {
            // Find the color used in the Bar Chart for this doctor
            const docIndex = docNames.indexOf(docName);
            const color = (docIndex !== -1) ? docColors[docIndex] : '#000'; // Fallback
            
            return {
                label: docName, 
                data: docTrends[docName], 
                borderColor: color, 
                backgroundColor: 'transparent', 
                tension: 0.1
            };
        });
        createChart('trendChart', 'line', monthKeys, trendDatasets, 'line');
    }

    function createChart(canvasId, type, labels, datasets, mode) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        if(charts[canvasId]) charts[canvasId].destroy();

        charts[canvasId] = new Chart(ctx, {
            type: type,
            data: { labels: labels, datasets: datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: true } // FORCE LEGEND on both charts
                },
                onClick: (e, activeEls) => {
                    if (activeEls.length > 0) {
                        const index = activeEls[0].index;
                        const dsIndex = activeEls[0].datasetIndex;
                        const activeFY = document.getElementById('fyDropdown').value;
                        
                        switchTab('data');
                        document.getElementById('dataFyFilter').value = activeFY;
                        
                        if (mode === 'bar') {
                            const docName = labels[index];
                            document.getElementById('doctorFilter').value = docName;
                        } 
                        else if (mode === 'line') {
                            const docName = datasets[dsIndex].label; 
                            const monthShort = labels[index]; 
                            const years = activeFY.replace("FY","").split("/"); 
                            const startY = "20" + years[0];
                            const endY = "20" + years[1];
                            const fullYear = (index <= 5) ? startY : endY;
                            const fullMonthString = `${monthShort} ${fullYear}`; 
                            
                            document.getElementById('doctorFilter').value = docName;
                            populateMonthDropdown();
                            document.getElementById('monthFilter').value = fullMonthString;
                        }
                        document.getElementById('applyFilters').click();
                    }
                }
            }
        });
    }

    // --- DATA TABLE & OTHER LOGIC (Unchanged) ---
    document.getElementById('applyFilters').onclick = () => {
        const fy = document.getElementById('dataFyFilter').value;
        const m = document.getElementById('monthFilter').value;
        const d = document.getElementById('dateFilter').value;
        const doc = document.getElementById('doctorFilter').value.toLowerCase();
        
        const filtered = allRecords.filter(r => {
            const matchFY = !fy || getFinancialYear(r.jsDate) === fy;
            const matchM = !m || r.jsDate.toLocaleString('default', { month: 'short', year: 'numeric' }) === m;
            const matchD = !d || r.reportDate === d.split('-').reverse().join('/');
            const matchDoc = !doc || r.doctorName.toLowerCase().includes(doc);
            return matchFY && matchM && matchD && matchDoc;
        });
        renderDashboard(filtered);
    };

    document.getElementById('clearFilters').onclick = () => {
        document.getElementById('dataFyFilter').value = "";
        populateMonthDropdown();
        document.getElementById('monthFilter').value = ""; 
        document.getElementById('dateFilter').value = ""; 
        document.getElementById('doctorFilter').value = "";
        renderDashboard(allRecords);
    };

    function renderDashboard(data) {
        const tbody = document.getElementById('recordsTableBody');
        tbody.innerHTML = "";
        let tRec=0, tFee=0, tGST=0, tRem=0;
        data.sort((a,b) => b.jsDate - a.jsDate).forEach(d => {
            const {rate, isEx} = getRate(d.doctorName, d.jsDate);
            const fee = d.amountReceived * (rate / 100);
            const gst = fee * 0.10;
            const remit = d.amountReceived - (fee + gst);
            tRec += d.amountReceived; tFee += fee; tGST += gst; tRem += remit;
            const badge = isEx ? `<span style="background:#fff3cd; color:#856404; padding:2px 6px; border-radius:4px; font-size:11px;">${rate}% (Ex)</span>` 
                               : `<span style="background:#e7f1ff; color:#0056b3; padding:2px 6px; border-radius:4px; font-size:11px;">${rate}%</span>`;
            tbody.innerHTML += `<tr><td>${d.reportDate}</td><td style="font-weight:600;">${d.doctorName}</td><td>${d.location}</td><td class="money-col">${formatCurr(d.amountReceived)}</td><td style="text-align:center;">${badge}</td><td class="money-col">${formatCurr(fee)}</td><td class="money-col">${formatCurr(gst)}</td><td class="money-col" style="color:#28a745;">${formatCurr(remit)}</td><td style="text-align:center;"><button class="btn btn-danger" style="font-size:10px;" onclick="deleteRecord('${d.id}')">Del</button></td></tr>`;
        });
        document.getElementById('totalReceived').innerText = formatCurr(tRec);
        document.getElementById('totalFee').innerText = formatCurr(tFee);
        document.getElementById('totalGST').innerText = formatCurr(tGST);
        document.getElementById('totalRemit').innerText = formatCurr(tRem);
    }

    // SHARED UTILS
    function getRate(docName, jsDate) {
        const set = doctorSettingsMap[docName];
        if(!set) return { rate: 0, isEx: false };
        const mStr = jsDate.toLocaleString('default', { month: 'short', year: 'numeric' });
        if(set.exceptions && set.exceptions[mStr] !== undefined) return { rate: parseFloat(set.exceptions[mStr]), isEx: true };
        if(set.timeline && set.timeline.length > 0) {
            const sorted = [...set.timeline].sort((a,b) => new Date(b.startDate) - new Date(a.startDate));
            const rule = sorted.find(r => new Date(r.startDate) <= jsDate);
            if(rule) return { rate: parseFloat(rule.fee), isEx: false };
        }
        return { rate: 0, isEx: false };
    }
    window.switchTab = (tab) => {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`tab-${tab}`).classList.add('active');
        let btnId = 'tabBtnVisuals';
        if(tab === 'data') btnId = 'tabBtnData';
        if(tab === 'settings') btnId = 'tabBtnSet';
        document.getElementById(btnId).classList.add('active');
    };
    document.getElementById('excelFile').onchange = function() {
        const status = document.getElementById('uploadStatus');
        status.style.color = "blue"; status.innerText = "Processing...";
        const reader = new FileReader();
        reader.onload = async function(e) {
            try {
                const wb = XLSX.read(new Uint8Array(e.target.result), {type: 'array'});
                const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { header: 1 });
                let date = "", hIdx = -1;
                for(let i=0; i<Math.min(rows.length, 25); i++){
                    const txt = (rows[i]||[]).join(" ");
                    if(txt.includes("Period")){ const m = txt.match(/\d{1,2}\/\d{1,2}\/\d{4}/g); if(m) date=m[0]; }
                    if((rows[i]||[]).includes("Doctor")) hIdx=i;
                }
                const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { range: hIdx });
                const batch = db.batch(); let count=0;
                for(const r of json){
                    const keys = Object.keys(r);
                    const doc = (r[keys.find(k=>k.trim()==='Doctor')]||"").toString().trim();
                    if(doc && !doc.includes("Total:")){
                        const loc = r[keys.find(k=>k.trim()==='Location')]||"N/A";
                        const id = `${date}_${doc}_${loc}`.replace(/\//g,'-').replace(/\s+/g,'_');
                        batch.set(db.collection("daily_reports").doc(id), {
                            reportDate: date, doctorName: doc, location: loc,
                            amountBilled: parseFloat(r[keys.find(k=>k.trim()==='Amount Billed')])||0,
                            amountReceived: parseFloat(r[keys.find(k=>k.trim()==='Amount Received')])||0,
                            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                        }, {merge:true}); count++;
                    }
                }
                await batch.commit();
                status.style.color = "green"; status.innerText = `‚úî ${count} Saved`;
                setTimeout(loadAllData, 1000);
            } catch(e) { status.style.color="red"; status.innerText=e.message; }
        };
        reader.readAsArrayBuffer(this.files[0]);
    };
    function renderDoctorList() {
        const doctors = [...new Set(allRecords.map(r => r.doctorName))].sort();
        const panel = document.getElementById('doctorListPanel'); panel.innerHTML = "";
        doctors.forEach(name => {
            const div = document.createElement('div'); div.className = "doctor-item"; div.innerText = name;
            div.onclick = () => { document.querySelectorAll('.doctor-item').forEach(i => i.classList.remove('selected')); div.classList.add('selected'); openConfig(name); };
            panel.appendChild(div);
        });
    }
    function openConfig(name) {
        currentEditingDoc = name; document.getElementById('noDocSelected').style.display = 'none'; document.getElementById('configPanel').style.display = 'block';
        document.getElementById('configTitle').innerText = name;
        const set = doctorSettingsMap[name] || { timeline: [], exceptions: {} };
        document.getElementById('timelineContainer').innerHTML = ""; document.getElementById('exceptionsContainer').innerHTML = "";
        (set.timeline || []).forEach(r => addTimelineRow(r.startDate, r.fee));
        Object.entries(set.exceptions || {}).forEach(([m, f]) => addExceptionRow(m, f));
    }
    window.addTimelineRow = (d="", f="") => {
        const div = document.createElement('div'); div.className = "input-group";
        div.innerHTML = `<input type="date" class="tl-d" value="${d}"><input type="number" class="tl-f" value="${f}" style="width:60px;"><button class="btn btn-danger" onclick="this.parentElement.remove()">√ó</button>`;
        document.getElementById('timelineContainer').appendChild(div);
    };
    window.addExceptionRow = (m="", f="") => {
        const div = document.createElement('div'); div.className = "input-group";
        div.innerHTML = `<input type="text" class="ex-m" value="${m}" placeholder="Nov 2025"><input type="number" class="ex-f" value="${f}" style="width:60px;"><button class="btn btn-danger" onclick="this.parentElement.remove()">√ó</button>`;
        document.getElementById('exceptionsContainer').appendChild(div);
    };
    window.saveDoctorSettings = async () => {
        const tl = []; document.querySelectorAll('.tl-d').forEach((el, i) => { const f = document.querySelectorAll('.tl-f')[i].value; if(el.value && f) tl.push({ startDate: el.value, fee: f }); });
        const ex = {}; document.querySelectorAll('.ex-m').forEach((el, i) => { const f = document.querySelectorAll('.ex-f')[i].value; if(el.value && f) ex[el.value] = f; });
        await db.collection("doctor_settings").doc(currentEditingDoc).set({ timeline: tl, exceptions: ex });
        document.getElementById('saveStatus').innerText = "Saved!"; loadAllData();
    };
    window.deleteRecord = async (id) => { if(confirm("Delete?")) { await db.collection("daily_reports").doc(id).delete(); loadAllData(); }};
</script>
</body>
</html>
